#!/bin/bash

CURRENT_STATEMENT=""

execute_sql() {
    echo $CURRENT_STATEMENT | sqlplus.exe -S coffeeshop/pass@localhost
}

#CURRENT_STATEMENT="alter system flush buffer_cache;" && execute_sql
#CURRENT_STATEMENT="alter system flush shared_pool;" && execute_sql
#CURRENT_STATEMENT="set autotrace traceonly statistics;" && execute_sql

delete_table() {
    START=$(date +%s.%N)
    CURRENT_STATEMENT="DROP TABLE $1;" && execute_sql
    END=$(date +%s.%N)
    DIFF=$(echo "$END - $START" | bc)
    echo "time: $DIFF s"
}

create_table_sql() {
    echo $1
    START=$(date +%s.%N)
    CURRENT_STATEMENT="CREATE TABLE $1"' (id number(10) GENERATED BY DEFAULT AS IDENTITY, transaction_datetime timestamp NOT NULL, in_store number NOT NULL, "order" number(10) NOT NULL, line_item_id number(10) NOT NULL, quantity number(10) NOT NULL, line_item_amount number(10, 2) NOT NULL, unit_price number(10, 2) NOT NULL, promo number NOT NULL, sales_outlet_id number(10), staff_id number(10) NOT NULL, customer_id number(10), product_id number(10) NOT NULL, PRIMARY KEY (id)) INMEMORY '"$2;" && execute_sql
    END=$(date +%s.%N)
    DIFF=$(echo "$END - $START" | bc)
    echo "time: $DIFF s"
}

create_ext_tab_dir() {
    CURRENT_STATEMENT="CREATE OR REPLACE DIRECTORY ext_tab_dir as 'D:\Projects\advanced-databases\data\new_dataset';"
}

insert_in_table() {
    echo $1
    START=$(date +%s.%N)
    CURRENT_STATEMENT="INSERT INTO $1 (transaction_datetime, in_store,"'"order", line_item_id, quantity, line_item_amount, unit_price, promo, sales_outlet_id, staff_id, customer_id, product_id) SELECT transaction_datetime_ext, in_store_ext, order_ext, line_item_id_ext, quantity_ext, line_item_amount_ext, unit_price_ext, promo_ext, sales_outlet_id_ext, staff_id_ext, customer_id_ext, product_id_ext FROM EXTERNAL ((id_ext number(10) NOT NULL, transaction_datetime_ext timestamp NOT NULL, in_store_ext number NOT NULL, order_ext number(10) NOT NULL, line_item_id_ext number(10) NOT NULL, quantity_ext number(10) NOT NULL, line_item_amount_ext number(10, 2) NOT NULL, unit_price_ext number(10, 2) NOT NULL, promo_ext number NOT NULL, sales_outlet_id_ext number(10) NOT NULL, staff_id_ext number(10) NOT NULL, customer_id_ext number(10), product_id_ext number(10) NOT NULL) TYPE ORACLE_LOADER DEFAULT DIRECTORY ext_tab_dir ACCESS PARAMETERS ('" RECORDS DELIMITED BY '\n' FIELDS TERMINATED BY ';' ( id_ext, transaction_datetime_ext CHAR(20) DATE_FORMAT DATE MASK"'"yyyy.mm.dd HH24:MI:SS", in_store_ext, order_ext, line_item_id_ext, quantity_ext, line_item_amount_ext, unit_price_ext, promo_ext, sales_outlet_id_ext, staff_id_ext, customer_id_ext, product_id_ext)) LOCATION'" ('sales_receipt.csv') REJECT LIMIT UNLIMITED) sales_receipt_external;" && execute_sql
    END=$(date +%s.%N)
    DIFF=$(echo "$END - $START" | bc)
    echo "time: $DIFF s"
}

select_group() {
    echo $1
    START=$(date +%s.%N)
    CURRENT_STATEMENT="SELECT sales_outlet_id, COUNT(customer_id), SUM(unit_price), SUM(line_item_amount) FROM $1 GROUP BY sales_outlet_id;" && execute_sql
    END=$(date +%s.%N)
    DIFF=$(echo "$END - $START" | bc)
    echo "time: $DIFF s"
}

advanced_update() {
    echo $1
    START=$(date +%s.%N)
    CURRENT_STATEMENT="UPDATE $1 SET promo = 0, quantity = 0 WHERE unit_price > 4;" && execute_sql
    END=$(date +%s.%N)
    DIFF=$(echo "$END - $START" | bc)
    echo "time: $DIFF s"
}

echo "DELETE"
delete_table "sales_receipt_col_no_memcompress"
delete_table "sales_receipt_col_memcompress_query_low"
delete_table "sales_receipt_col_memcompress_query_high"
delete_table "sales_receipt_col_memcompress_capacity_low"
delete_table "sales_receipt_col_memcompress_capacity_high"

echo "CREATE"
create_table_sql "sales_receipt_col_no_memcompress" "NO MEMCOMPRESS"
create_table_sql "sales_receipt_col_memcompress_query_low" "MEMCOMPRESS FOR QUERY LOW"
create_table_sql "sales_receipt_col_memcompress_query_high" "MEMCOMPRESS FOR QUERY HIGH"
create_table_sql "sales_receipt_col_memcompress_capacity_low" "MEMCOMPRESS FOR CAPACITY LOW"
create_table_sql "sales_receipt_col_memcompress_capacity_high" "MEMCOMPRESS FOR CAPACITY HIGH"

create_ext_tab_dir && execute_sql

echo "INSERT"
insert_in_table "sales_receipt_col_no_memcompress"
insert_in_table "sales_receipt_col_memcompress_query_low"
insert_in_table "sales_receipt_col_memcompress_query_high"
insert_in_table "sales_receipt_col_memcompress_capacity_low"
insert_in_table "sales_receipt_col_memcompress_capacity_high"

echo "SELECT"
select_group "sales_receipt_col_no_memcompress"
select_group "sales_receipt_col_memcompress_query_low"
select_group "sales_receipt_col_memcompress_query_high"
select_group "sales_receipt_col_memcompress_capacity_low"
select_group "sales_receipt_col_memcompress_capacity_high"

echo "UPDATE"
advanced_update "sales_receipt_col_no_memcompress"
advanced_update "sales_receipt_col_memcompress_query_low"
advanced_update "sales_receipt_col_memcompress_query_high"
advanced_update "sales_receipt_col_memcompress_capacity_low"
advanced_update "sales_receipt_col_memcompress_capacity_high"

echo "DELETE"
delete_table "sales_receipt_col_no_memcompress"
delete_table "sales_receipt_col_memcompress_query_low"
delete_table "sales_receipt_col_memcompress_query_high"
delete_table "sales_receipt_col_memcompress_capacity_low"
delete_table "sales_receipt_col_memcompress_capacity_high"